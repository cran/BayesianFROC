---
title: "Appendix:Notations and details"
author: "Issei Tsunoda"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Appendix:Notations and details}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r,echo=FALSE}
knitr::opts_chunk$set(collapse = TRUE,comment ="#>",eval = F)
```

# Appendix
 `r paste0("![Radiograph](",system.file("image", "a.jpg", package="BayesianFROC"),")")`

I think for the users of this package the following definitions are no need to understand nor remember. To tell the truth, the author sometimes forget these definitions when I develop this packages or running this code. So, do not bother yourself even if you can not understand the following things. Especially, I think for the  medical researcher or radiologists it is difficult to understand. I studied mathematics (Differential Geometry) in some university, so it is very easy for me, but I do not want to force the users of this package to understand these precise definitions, and it is the reason why I put these in Appendix.



###### Notations:

$\Phi()$ denotes the cumulative distribution function of the Gaussian distribution with mean 0 and variance 1.
$\Phi^{-1}()$ is the inverse mapping of $\Phi()$.


### Definition of FROC curves


Let $(x,y)$ be a Cartesian coordinate system on a plane. Then, for any non-negative real number $\lambda$, the FROC curve is defined as 
$$
(x(\lambda),y(\lambda)) :=  \bigl(\lambda , 1-\Phi(b\Phi ^{-1}(\exp(-\lambda)) -a ) \bigr)
$$
Or 

$$
 (x(\lambda),y(\lambda)) :=   \bigl(\lambda , \text{Prob} \bigr\{ X_i > \Phi ^{-1}(\exp(-\lambda)) \bigl\} \bigr).
$$
It is easy to see that these two definition is  same.

Note that AUC of FROC is infinity. So, in this package AUC means the next AFROC curve's AUC.

### Definition of AFROC curves


Similarly, let $(\xi, \eta)$ be a Cartesian coordinate system for the square $0\leq \xi \leq 1, 0\leq \eta \leq 1$. Then, for any non-negative real number $\lambda$, we define an AFROC curve as
$$(\xi(\lambda), \eta(\lambda)) := \bigl(1-\exp(-\lambda) , 1-\Phi(b\Phi ^{-1}(\exp(-\lambda)) -a ) \bigr).
$$

### Definition of Cumulative false positives and true positives

we define $C$ points as follows:
$$
(x_{c},y_{c}):=( \sum_{c\leq c' \leq C } F_{c^\prime}/N_{I}, \sum_{c\leq c' \leq C } H_{c^\prime}/N_{L}),
$$
where $c$ is the $c^{\text{th}}$ confidence level, and we call these points the _cumulative false positive-cumulative true positive (CFP-CTP) points over $(N_I, N_L)$_. 

In the  case of single reader and single modality, this is used if `ModifiedPoisson = FALSE` in `BayesianFROC::fit_Bayesian_FROC()`.
IF `ModifiedPoisson = FALSE` is true then the following points are depicted instead:

$$
(x_{c},y_{c}):=( \sum_{c\leq c' \leq C } F_{c^\prime}/N_{L}, \sum_{c\leq c' \leq C } H_{c^\prime}/N_{L}),
$$

####Another model for Multiple FROC curves

The following model are implemented in the function `BayesianFROC::fit_MRMC_versionTWO()`.


 $$H_{c,m,r}   \sim  \text{Binomial}( p_{c,m,r}, N_L ),  $$
 $$F_{c,m,r}  \sim  \text{Poisson} ( ( \lambda _{c} - \lambda _{c+1})N_L ), $$ 
 $$\lambda _{c}  =  - \log \Phi (z_{c }),  $$
 $$p_{c,m,r}
 := \Phi (\frac{z_{c +1}-\mu_{m,r}}{\sigma_{m,r}})-\Phi (\frac{z_{c}-\mu_{m,r}}{\sigma_{m,r}}), $$  
 $$A_{m,r} := \Phi (\frac{\mu_{m,r}/\sigma_{m,r}}{\sqrt{(1/\sigma_{m,r})^2+1}}),  $$ 

 $$A_{m,r} \sim \text{Normal} (A_{m},\sigma_{r}^2),   $$
 $$\mu_{m,r} \sim \text{Normal} (\mu_{m},\sigma _{\mu,m}^2),   $$
 $$\sigma_{m,r} \sim \text{Normal} (\sigma_{m},\sigma _{\sigma,m}^2),   $$
$$  a_{m} :=\mu_{m} / \sigma_{m}     $$
$$  b_{m} := 1/ \sigma_{m}      $$
 $$dz_c := z_{c+1}-z_{c},  $$
 $$dz_c, \sigma_{m,r}  \sim  \text{Uniform}(0,\infty),  $$
 $$z_{c}  \sim  \text{Uniform}( -\infty,100000),  $$
 $$A_{m}  \sim  \text{Uniform}(0,1).  $$


## Priors
We introduce a new parameter:
$$
dz_c:=z_{c+1}-z_{c},
$$
where $c=1,2,\cdots,C$. In practical modeling, we do not use the previous section's parameters $z_2,z_3,\cdots, z_C$, using $z_{c}, dz_1,dz_2,\cdots, dz_{C}$ instead. To include an order constraint for Bayesian models, we assume a non-regular uniform prior for $dz_c$:
$$
dz_c \sim \text{Uniform}(0, \infty),
$$
where $\text{Uniform}(0,\infty)$ indicates improper priors whose integrated values are not one. These priors are equivalent in that we assume monotonicity in the thresholds, as follows:
$$ z_{1}\leq z_{2}\leq z_{3} \leq \dots \leq z_{C+1}.$$
Once we apply the above priors for monotonicity to the breaking of symmetry, then the Poisson rates $\lambda_{c}$ automatically inherit this order constraint, as follows:
$$ \lambda_{1}\geq \lambda_{2}\geq \lambda_{3} \geq \dots \geq \lambda_{C+1}.$$
Furthermore, we must restrict the highest threshold $z_{C+1}$, which theoretically is infinity. However, computing the estimate requires assuming its upper bounds. 
$$
z_{C+1} \sim \text{Uniform}( -\infty,100000).
$$
where $\text{Uniform}(-\infty,100000)$ means improper priors as above.
If we do not place an upper bound o $z_{C+1}$, then $z_{C+1}$ is not convergent in Markov Chain Monte Carlo (MCMC) sampling. Our computation uses the upper bound of 100,000. Its value does not affect the other parameters significantly except for $z_{C+1}$. Note that when we programmed in C++ for the Stan language, we used the array format for thresholds $z_c$, leading to some unnecessarily strong constraints, as follows:
$$
z_{c} \sim \text{Uniform}( -\infty,100000),
$$ 
for all $c$ (not only $C+1$).
We omit the graphical model of this modified version because of its complexity. Consequently, we have the Bayesian model
$$
H_{c }   \sim  \text{Binomial} ( p_{c}, N_{L} ),$$
$$F_{c }   \sim  \text{Poisson} ( (\lambda _{c} -\lambda _{c+1} )\times N_{I} ),$$
$$\lambda _{c}  =  - \log \Phi ( z_{c } ),$$
$$p_{c}
 = \Phi (\frac{z_{c +1}-\mu}{\sigma})-\Phi (\frac{z_{c}-\mu}{\sigma}). $$
$$dz_c := z_{c+1}-z_{c},$$
$$dz_c  \sim  \text{Uniform}(0,\infty),$$
$$z_{c}   \sim  \text{Uniform}( -\infty,100000).$$
 
Our new model has parameters $z_{1}, dz_1,dz_2,\cdots, dz_{C}$, $\mu$, and $\sigma$. Note that $z_2, z_3, \cdots, z_C$ are no longer the parameters of this symmetry-breaking model.


# Questions and Supports


If user has any questions, please tell me.

tsunoda.issei1111    *__at__*  gmail.com
